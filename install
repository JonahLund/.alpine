#!/bin/sh

# Exit on any error
set -e

# Check if sudo is available
command -v sudo > /dev/null 2>&1 || { echo >&2 "The script requires 'sudo' but it's not installed.  Aborting."; exit 1; }

# Function to add a user to groups if not already added
add_user_to_group() {
    for group in "$@"; do
        if ! id -nG "$USER" | grep -qw "$group"; then
            sudo adduser "$USER" "$group"
        fi
    done
}

# Function to install packages
install_packages() {
    for package in "$@"; do
        if ! apk info -e "$package" > /dev/null 2>&1; then
            sudo apk add "$package"
        fi
    done
}

# Update and upgrade packages
echo "Updating and upgrading packages..."
sudo apk update && sudo apk upgrade

# Install Development Essentials
echo "Installing Development Essentials..."
install_packages build-base cmake openssl-dev git fontconfig-dev

# Install Audio/Video related packages
echo "Installing Audio/Video related packages..."
install_packages pulseaudio linux-firmware-amdgpu mesa mesa-dri-gallium mesa-va-gallium mesa-vulkan-ati

# Install Wayland/Sway related packages
echo "Installing Wayland/Sway related packages..."
install_packages wayland xwayland wl-clipboard sway swaylock swaybg swayidle udev dbus seatd cmd:seatd-launch imv grim grimshot

# Install Developer tools
echo "Installing Developer tools..."
install_packages redis helix ripgrep rustup nodejs-current yarn sccache 

# Install Applications
echo "Installing Applications..."
install_packages firefox alacritty tmux font-jetbrains-mono-nerd

# Install elogind
echo "Installing elogind..."
install_packages elogind
sudo rc-update add elogind default
sudo service elogind start

# Install rust
echo "Installing Rust..."
rustup-init -y --default-toolchain nightly 
. "$HOME/.cargo/env"
. "$HOME/.alpine/dotfiles/.profile"

# Install cargo binaries
echo "Installing Cargo binaries..."
rustup target add x86_64-unknown-linux-musl
cargo install kickoff cargo-watch dotlink --target x86_64-unknown-linux-musl

# Link dotfiles
echo "Linking dotfiles..."
mkdir -p ~/.config
cd dotfiles && dotlink -p linux --file ../dotlink.toml

# Install LSPs
sudo npm i -g typescript typescript-language-server @astrojs/language-server vscode-langservers-extracted
rustup component add rust-analyzer

# Setup services
echo "Setting up services..."
echo amdgpu | sudo tee -a /etc/modules
echo fbcon | sudo tee -a /etc/modules
sudo setup-devd udev
echo $(sudo dbus-uuidgen) | sudo tee /var/lib/dbus/machine-id >/dev/null
sudo rc-update add dbus
sudo rc-update add seatd default
sudo rc-service dbus start

# Add user to groups
echo "Adding user to groups..."
add_user_to_group input video seat

# Setup helix
hx --grammar fetch
hx --grammar build

echo "Installation completed!"
